{% extends "base.html" %}

{% block title %}Главная - PenTest Notes{% endblock %}

{% block content %}
<div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-project-diagram"></i> Проекты и сайты</h2>
        <div class="btn-group">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                <i class="fas fa-folder-plus"></i> Новый проект
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWebsiteModal">
                <i class="fas fa-plus"></i> Добавить сайт
            </button>
        </div>
    </div>

    <div id="websitesContainer">
    <!-- Проекты и сайты -->
    
    <!-- Сначала отображаем проекты с сайтами -->
    {% for project in projects %}
        {% set project_websites = websites|selectattr('project_id', 'equalto', project.id)|list %}
        {% if project_websites %}
    <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">
                <i class="fas fa-folder-open text-primary"></i> {{ project.name }}
                <span class="badge bg-primary ms-2">{{ project_websites|length }}</span>
            </h4>
        </div>
        
        <div class="row">
            {% for website in project_websites %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ website.name }}</h6>
                        <span class="badge {% if website.status == 'В работе' %}bg-warning{% else %}bg-secondary{% endif %} status-badge">
                            {{ website.status }}
                        </span>
                    </div>
                {% if website.screenshot %}
                <div class="card-img-top-container" style="height: 200px; overflow: hidden;">
                    <img src="{{ url_for('uploaded_file', filename=website.screenshot.split('/')[-1]) }}" 
                         class="card-img-top" 
                         alt="Скриншот {{ website.name }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                {% endif %}
                <div class="card-body">
                    <p class="card-text">
                        <small class="text-muted">
                            <i class="fas fa-link"></i> {{ website.url }}
                        </small>
                    </p>
                    <p class="card-text">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> Создан: {{ website.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </small>
                    </p>
                    
                    {% if website.functions %}
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-cogs"></i> Функций: {{ website.functions|length }}
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-code"></i> Технологии:
                        </small>
                        <div class="mt-1" id="technologies-{{ website.id }}">
                            <!-- Технологии будут загружены через JavaScript -->
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-network-wired"></i> Порты:
                        </small>
                        <div class="mt-1" id="ports-{{ website.id }}">
                            <!-- Порты будут загружены через JavaScript -->
                        </div>
                    </div>
                    
                    {% if website.certificates %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-certificate"></i> Сертификат:
                        </small>
                        <div class="mt-1" id="certificate-{{ website.id }}">
                            <script>
                            try {
                                const certData = JSON.parse(`{{ website.certificates|safe }}`);
                                const certElement = document.getElementById('certificate-{{ website.id }}');
                                if (certData.ip || certData.organization || certData.commonName || certData.san) {
                                    let certInfo = [];
                                    if (certData.ip) certInfo.push(`IP: ${certData.ip}`);
                                    if (certData.organization) certInfo.push(`Орг: ${certData.organization}`);
                                    if (certData.commonName) certInfo.push(`CN: ${certData.commonName}`);
                                    if (certData.san && certData.san.length > 0) {
                                        const sanArray = Array.isArray(certData.san) ? certData.san : [certData.san];
                                        const maxSanToShow = 3;
                                        if (sanArray.length <= maxSanToShow) {
                                            sanArray.forEach(san => certInfo.push(`SAN: ${san}`));
                                        } else {
                                            for (let i = 0; i < maxSanToShow; i++) {
                                                certInfo.push(`SAN: ${sanArray[i]}`);
                                            }
                                            certInfo.push(`SAN: +${sanArray.length - maxSanToShow} еще`);
                                        }
                                    }
                                    certElement.innerHTML = `<small class="text-success">${certInfo.join('<br>')}</small>`;
                                } else {
                                    certElement.innerHTML = '<small class="text-muted">Данные сертификата загружены</small>';
                                }
                            } catch (e) {
                                document.getElementById('certificate-{{ website.id }}').innerHTML = '<small class="text-warning">Некорректные данные сертификата</small>';
                            }
                            </script>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                        <a href="{{ url_for('website_detail', website_id=website.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> Открыть
                        </a>
                        <button class="btn btn-outline-warning btn-sm" onclick="editWebsite({{ website.id }})">
                            <i class="fas fa-edit"></i> Изменить
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteWebsite({{ website.id }})">
                            <i class="fas fa-trash"></i> Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>
        {% endif %}
    {% endfor %}
    
    <!-- Затем отображаем сайты без проекта -->
    {% set websites_without_project = websites|selectattr('project_id', 'none')|list %}
    {% if websites_without_project %}
    <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">
                <i class="fas fa-folder text-secondary"></i> Без проекта
                <span class="badge bg-secondary ms-2">{{ websites_without_project|length }}</span>
            </h4>
        </div>
        
        <div class="row">
            {% for website in websites_without_project %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ website.name }}</h6>
                        <span class="badge {% if website.status == 'В работе' %}bg-warning{% else %}bg-secondary{% endif %} status-badge">
                            {{ website.status }}
                        </span>
                    </div>
                {% if website.screenshot %}
                <div class="card-img-top-container" style="height: 200px; overflow: hidden;">
                    <img src="{{ url_for('uploaded_file', filename=website.screenshot.split('/')[-1]) }}" 
                         class="card-img-top" 
                         alt="Скриншот {{ website.name }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                {% endif %}
                <div class="card-body">
                    <p class="card-text">
                        <small class="text-muted">
                            <i class="fas fa-link"></i> {{ website.url }}
                        </small>
                    </p>
                    <p class="card-text">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> Создан: {{ website.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </small>
                    </p>
                    
                    {% if website.functions %}
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-cogs"></i> Функций: {{ website.functions|length }}
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-code"></i> Технологии:
                        </small>
                        <div class="mt-1" id="technologies-{{ website.id }}">
                            <!-- Технологии будут загружены через JavaScript -->
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-network-wired"></i> Порты:
                        </small>
                        <div class="mt-1" id="ports-{{ website.id }}">
                            <!-- Порты будут загружены через JavaScript -->
                        </div>
                    </div>
                    
                    {% if website.certificates %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-certificate"></i> Сертификат:
                        </small>
                        <div class="mt-1" id="certificate-{{ website.id }}">
                            <script>
                            try {
                                const certData = JSON.parse(`{{ website.certificates|safe }}`);
                                const certElement = document.getElementById('certificate-{{ website.id }}');
                                if (certData.ip || certData.organization || certData.commonName || certData.san) {
                                    let certInfo = [];
                                    if (certData.ip) certInfo.push(`IP: ${certData.ip}`);
                                    if (certData.organization) certInfo.push(`Орг: ${certData.organization}`);
                                    if (certData.commonName) certInfo.push(`CN: ${certData.commonName}`);
                                    if (certData.san && certData.san.length > 0) {
                                        const sanArray = Array.isArray(certData.san) ? certData.san : [certData.san];
                                        const maxSanToShow = 3;
                                        if (sanArray.length <= maxSanToShow) {
                                            sanArray.forEach(san => certInfo.push(`SAN: ${san}`));
                                        } else {
                                            for (let i = 0; i < maxSanToShow; i++) {
                                                certInfo.push(`SAN: ${sanArray[i]}`);
                                            }
                                            certInfo.push(`SAN: +${sanArray.length - maxSanToShow} еще`);
                                        }
                                    }
                                    certElement.innerHTML = `<small class="text-success">${certInfo.join('<br>')}</small>`;
                                } else {
                                    certElement.innerHTML = '<small class="text-muted">Данные сертификата загружены</small>';
                                }
                            } catch (e) {
                                document.getElementById('certificate-{{ website.id }}').innerHTML = '<small class="text-warning">Некорректные данные сертификата</small>';
                            }
                            </script>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                        <a href="{{ url_for('website_detail', website_id=website.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> Открыть
                        </a>
                        <button class="btn btn-outline-warning btn-sm" onclick="editWebsite({{ website.id }})">
                            <i class="fas fa-edit"></i> Изменить
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteWebsite({{ website.id }})">
                            <i class="fas fa-trash"></i> Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>
    {% endif %}
    </div>

    {% if not websites %}
    <div class="text-center py-5">
        <i class="fas fa-globe fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Нет добавленных сайтов</h4>
        <p class="text-muted">Добавьте первый сайт для начала работы</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWebsiteModal">
            <i class="fas fa-plus"></i> Добавить первый сайт
        </button>
    </div>
    {% endif %}
</div>

<!-- Модальное окно для добавления/редактирования сайта -->
<div class="modal fade" id="addWebsiteModal" tabindex="-1" aria-labelledby="addWebsiteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWebsiteModalLabel">Добавить новый сайт</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addWebsiteForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="websiteName" class="form-label">Название сайта *</label>
                        <input type="text" class="form-control" id="websiteName" required>
                    </div>
                    <div class="mb-3">
                        <label for="websiteUrl" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="websiteUrl" required>
                    </div>
                    <div class="mb-3">
                        <label for="websiteProject" class="form-label">Проект</label>
                        <select class="form-select" id="websiteProject">
                            <option value="">Выберите проект...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="websiteStatus" class="form-label">Статус</label>
                        <select class="form-select" id="websiteStatus">
                            <option value="Не начат">Не начат</option>
                            <option value="В работе">В работе</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="websiteScreenshot" class="form-label">Скриншот сайта</label>
                        <input type="file" class="form-control" id="websiteScreenshot" accept="image/*">
                        <div class="form-text">Поддерживаемые форматы: PNG, JPG, JPEG, GIF, WebP (макс. 16MB)</div>
                        <div id="screenshotPreview" class="mt-2" style="display: none;">
                            <img id="previewImage" src="" alt="Предпросмотр" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addWebsite()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления проекта -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProjectModalLabel">Создать новый проект</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProjectForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Название проекта *</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <div class="mb-3">
                        <label for="projectDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="projectDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="projectStatus" class="form-label">Статус</label>
                        <select class="form-select" id="projectStatus">
                            <option value="Активный">Активный</option>
                            <option value="Завершен">Завершен</option>
                            <option value="Приостановлен">Приостановлен</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="addProject()">Создать</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentWebsiteId = null;

// Функция для экранирования HTML символов
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addWebsite() {
    const name = document.getElementById('websiteName').value;
    const url = document.getElementById('websiteUrl').value;
    const projectId = document.getElementById('websiteProject').value;
    const status = document.getElementById('websiteStatus').value;
    const screenshot = document.getElementById('websiteScreenshot').files[0];
    
    if (!name || !url) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    let requestOptions;
    
    if (screenshot) {
        // Если есть файл, отправляем как FormData
        const formData = new FormData();
        formData.append('name', name);
        formData.append('url', url);
        formData.append('status', status);
        if (projectId) formData.append('project_id', projectId);
        formData.append('screenshot', screenshot);
        
        requestOptions = {
            method: 'POST',
            body: formData
        };
    } else {
        // Если нет файла, отправляем как JSON
        const data = {
            name: name,
            url: url,
            status: status
        };
        if (projectId) data.project_id = parseInt(projectId);
        
        requestOptions = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        };
    }
    
    fetch('/api/websites', requestOptions)
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Ошибка при создании сайта');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при создании сайта');
    });
}

function editWebsite(websiteId) {
    // Получаем данные сайта и заполняем форму
    fetch(`/api/websites/${websiteId}`)
    .then(response => response.json())
    .then(data => {
        document.getElementById('websiteName').value = data.name;
        document.getElementById('websiteUrl').value = data.url;
        document.getElementById('websiteProject').value = data.project_id || '';
        document.getElementById('websiteStatus').value = data.status;
        currentWebsiteId = websiteId;
        
        // Меняем заголовок и кнопку модального окна
        document.querySelector('#addWebsiteModal .modal-title').textContent = 'Редактировать сайт';
        document.querySelector('#addWebsiteModal .btn-primary').textContent = 'Сохранить';
        document.querySelector('#addWebsiteModal .btn-primary').setAttribute('onclick', 'updateWebsite()');
        
        new bootstrap.Modal(document.getElementById('addWebsiteModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при загрузке данных сайта');
    });
}

function updateWebsite() {
    const name = document.getElementById('websiteName').value;
    const url = document.getElementById('websiteUrl').value;
    const projectId = document.getElementById('websiteProject').value;
    const status = document.getElementById('websiteStatus').value;
    const screenshot = document.getElementById('websiteScreenshot').files[0];
    
    if (!name || !url) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    let requestOptions;
    
    if (screenshot) {
        // Если есть файл, отправляем как FormData
        const formData = new FormData();
        formData.append('name', name);
        formData.append('url', url);
        formData.append('status', status);
        if (projectId) formData.append('project_id', projectId);
        formData.append('screenshot', screenshot);
        
        requestOptions = {
            method: 'PUT',
            body: formData
        };
    } else {
        // Если нет файла, отправляем как JSON
        const data = {
            name: name,
            url: url,
            status: status
        };
        if (projectId) data.project_id = parseInt(projectId);
        
        requestOptions = {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        };
    }
    
    fetch(`/api/websites/${currentWebsiteId}`, requestOptions)
    .then(response => response.json())
    .then(data => {
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении сайта');
    });
}

function deleteWebsite(websiteId) {
    if (confirm('Вы уверены, что хотите удалить этот сайт? Все связанные данные будут потеряны.')) {
        fetch(`/api/websites/${websiteId}`, {
            method: 'DELETE'
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        })
        .then(data => {
            console.log('Delete success:', data);
            alert('Сайт успешно удален!');
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении сайта: ' + error.message);
        });
    }
}

// Предпросмотр изображения
document.getElementById('websiteScreenshot').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('screenshotPreview');
    const previewImage = document.getElementById('previewImage');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

// Сброс формы при закрытии модального окна
document.getElementById('addWebsiteModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('addWebsiteForm').reset();
    document.getElementById('screenshotPreview').style.display = 'none';
    document.querySelector('#addWebsiteModal .modal-title').textContent = 'Добавить новый сайт';
    document.querySelector('#addWebsiteModal .btn-primary').textContent = 'Добавить';
    document.querySelector('#addWebsiteModal .btn-primary').setAttribute('onclick', 'addWebsite()');
    currentWebsiteId = null;
});

// Загрузка технологий и портов для всех сайтов
window.addEventListener('load', function() {
    {% for website in websites %}
    setTimeout(() => {
        loadTechnologies({{ website.id }});
        loadPorts({{ website.id }});
    }, 100);
    {% endfor %}
});

// Функция загрузки технологий
function loadTechnologies(websiteId) {
    console.log(`Loading technologies for website ${websiteId}`);
    const container = document.getElementById(`technologies-${websiteId}`);
    
    if (!container) {
        console.error(`Container technologies-${websiteId} not found`);
        return;
    }
    
    fetch(`/api/websites/${websiteId}/technologies`)
    .then(response => {
        console.log(`Technologies response status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(technologies => {
        console.log(`Loaded ${technologies.length} technologies for website ${websiteId}:`, technologies);
        container.innerHTML = '';
        
        if (technologies.length === 0) {
            container.innerHTML = '<span class="text-muted small">Не указаны</span>';
            return;
        }
        
        technologies.forEach(tech => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-info text-dark';
            badge.style.cssText = 'display: inline-block; margin: 2px 5px 2px 0; cursor: pointer;';
            badge.innerHTML = `${escapeHtml(tech.name)}${tech.version ? ' ' + escapeHtml(tech.version) : ''} <i class="fas fa-times ms-1" onclick="deleteTechnology(${tech.id}, ${websiteId})"></i>`;
            badge.title = 'Нажмите на крестик для удаления';
            container.appendChild(badge);
        });
        
        // Добавляем кнопку для добавления новой технологии
        const addBtn = document.createElement('span');
        addBtn.className = 'badge bg-secondary';
        addBtn.style.cssText = 'display: inline-block; margin: 2px 5px 2px 0; cursor: pointer;';
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Добавить';
        addBtn.onclick = () => addTechnology(websiteId);
        container.appendChild(addBtn);
    })
    .catch(error => {
        console.error('Error loading technologies:', error);
        if (container) {
            container.innerHTML = '<span class="text-danger small">Ошибка загрузки</span>';
        }
    });
}

// Функция загрузки портов
function loadPorts(websiteId) {
    console.log(`Loading ports for website ${websiteId}`);
    const container = document.getElementById(`ports-${websiteId}`);
    
    if (!container) {
        console.error(`Container ports-${websiteId} not found`);
        return;
    }
    
    fetch(`/api/websites/${websiteId}/ports`)
    .then(response => {
        console.log(`Ports response status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(ports => {
        console.log(`Loaded ${ports.length} ports for website ${websiteId}:`, ports);
        container.innerHTML = '';
        
        if (ports.length === 0) {
            container.innerHTML = '<span class="text-muted small">Не указаны</span>';
            return;
        }
        
        ports.forEach(port => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success';
            badge.style.cssText = 'display: inline-block; margin: 2px 5px 2px 0; cursor: pointer;';
            badge.innerHTML = `${port.number}${port.service ? ' (' + escapeHtml(port.service) + ')' : ''} <i class="fas fa-times ms-1" onclick="deletePort(${port.id}, ${websiteId})"></i>`;
            badge.title = 'Нажмите на крестик для удаления';
            container.appendChild(badge);
        });
        
        // Добавляем кнопку для добавления нового порта
        const addBtn = document.createElement('span');
        addBtn.className = 'badge bg-secondary';
        addBtn.style.cssText = 'display: inline-block; margin: 2px 5px 2px 0; cursor: pointer;';
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Добавить';
        addBtn.onclick = () => addPort(websiteId);
        container.appendChild(addBtn);
    })
    .catch(error => {
        console.error('Error loading ports:', error);
        if (container) {
            container.innerHTML = '<span class="text-danger small">Ошибка загрузки</span>';
        }
    });
}

// Функция добавления технологии
function addTechnology(websiteId) {
    const name = prompt('Введите название технологии:');
    if (!name) return;
    
    const version = prompt('Введите версию (необязательно):') || '';
    
    fetch(`/api/websites/${websiteId}/technologies`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name.trim(),
            version: version.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            loadTechnologies(websiteId);
        } else {
            alert('Ошибка при добавлении технологии');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при добавлении технологии');
    });
}

// Функция добавления порта
function addPort(websiteId) {
    const number = prompt('Введите номер порта:');
    if (!number || isNaN(number)) {
        alert('Пожалуйста, введите корректный номер порта');
        return;
    }
    
    const service = prompt('Введите название сервиса (необязательно):') || '';
    
    fetch(`/api/websites/${websiteId}/ports`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            number: parseInt(number),
            service: service.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            loadPorts(websiteId);
        } else {
            alert('Ошибка при добавлении порта');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при добавлении порта');
    });
}

// Функция удаления технологии
function deleteTechnology(techId, websiteId) {
    if (confirm('Удалить эту технологию?')) {
        fetch(`/api/technologies/${techId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            loadTechnologies(websiteId);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении технологии');
        });
    }
}

// Функция удаления порта
function deletePort(portId, websiteId) {
    if (confirm('Удалить этот порт?')) {
        fetch(`/api/ports/${portId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            loadPorts(websiteId);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении порта');
        });
    }
}

// Функция добавления проекта
function addProject() {
    const name = document.getElementById('projectName').value;
    const description = document.getElementById('projectDescription').value;
    const status = document.getElementById('projectStatus').value;
    
    if (!name) {
        alert('Пожалуйста, введите название проекта');
        return;
    }
    
    fetch('/api/projects', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            description: description,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Ошибка при создании проекта');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при создании проекта');
    });
}
</script>
{% endblock %}