{% extends "base.html" %}

{% block title %}{{ project.name }} - Сайты проекта{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Проекты</a></li>
                            <li class="breadcrumb-item active" aria-current="page">{{ project.name }}</li>
                        </ol>
                    </nav>
                    <h1>
                        <i class="fas fa-folder-open text-primary"></i> {{ project.name }}
                        <span class="badge {% if project.status == 'Активный' %}bg-success{% elif project.status == 'В работе' %}bg-warning{% else %}bg-secondary{% endif %} ms-2">
                            {{ project.status }}
                        </span>
                    </h1>
                    {% if project.description %}
                    <p class="text-muted">{{ project.description }}</p>
                    {% endif %}
                </div>
                <div>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addWebsiteModal">
                        <i class="fas fa-plus"></i> Добавить сайт
                    </button>
                    <button class="btn btn-outline-warning me-2" onclick="editProject({{ project.id }})">
                        <i class="fas fa-edit"></i> Редактировать проект
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="websitesContainer">
        {% if websites %}
        <div class="row">
            {% for website in websites %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ website.name }}</h6>
                        <span class="badge {% if website.status == 'В работе' %}bg-warning{% else %}bg-secondary{% endif %} status-badge">
                            {{ website.status }}
                        </span>
                    </div>
                    {% if website.screenshot %}
                    <div class="card-img-top-container" style="height: 200px; overflow: hidden;">
                        <img src="{{ url_for('uploaded_file', filename=website.screenshot.split('/')[-1]) }}" 
                             class="card-img-top" 
                             alt="Скриншот {{ website.name }}"
                             style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-link"></i> {{ website.url }}
                            </small>
                        </p>
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i> Создан: {{ website.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </small>
                        </p>
                        
                        {% if website.functions %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-cogs"></i> Функций: {{ website.functions|length }}
                            </small>
                        </div>
                        {% endif %}
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-code"></i> Технологии:
                            </small>
                            <div class="mt-1" id="technologies-{{ website.id }}">
                                <!-- Технологии будут загружены через JavaScript -->
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-network-wired"></i> Порты (по IP):
                            </small>
                            <div class="mt-1" id="ports-{{ website.id }}">
                                <!-- Порты будут загружены через JavaScript -->
                            </div>
                        </div>
                        
                        {% if website.certificates %}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-certificate"></i> Сертификат:
                            </small>
                            <div class="mt-1" id="certificate-{{ website.id }}">
                                <script>
                                try {
                                    const certData = JSON.parse(`{{ website.certificates|safe }}`);
                                    const certElement = document.getElementById('certificate-{{ website.id }}');
                                    if (certData.ip || certData.organization || certData.commonName || certData.san) {
                                        let certInfo = [];
                                        if (certData.ip) certInfo.push(`IP: ${certData.ip}`);
                                        if (certData.organization) certInfo.push(`Орг: ${certData.organization}`);
                                        if (certData.commonName) certInfo.push(`CN: ${certData.commonName}`);
                                        if (certData.san && certData.san.length > 0) {
                                            const sanArray = Array.isArray(certData.san) ? certData.san : [certData.san];
                                            const maxSanToShow = 3;
                                            if (sanArray.length <= maxSanToShow) {
                                                sanArray.forEach(san => certInfo.push(`SAN: ${san}`));
                                            } else {
                                                for (let i = 0; i < maxSanToShow; i++) {
                                                    certInfo.push(`SAN: ${sanArray[i]}`);
                                                }
                                                certInfo.push(`SAN: +${sanArray.length - maxSanToShow} еще`);
                                            }
                                        }
                                        certElement.innerHTML = `<small class="text-success">${certInfo.join('<br>')}</small>`;
                                    } else {
                                        certElement.innerHTML = '<small class="text-muted">Данные сертификата загружены</small>';
                                    }
                                } catch (e) {
                                    document.getElementById('certificate-{{ website.id }}').innerHTML = '<small class="text-warning">Некорректные данные сертификата</small>';
                                }
                                </script>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('website_detail', website_id=website.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i> Открыть
                            </a>
                            <button class="btn btn-outline-warning btn-sm" onclick="editWebsite({{ website.id }})">
                                <i class="fas fa-edit"></i> Изменить
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteWebsite({{ website.id }})">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-globe fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">В проекте нет сайтов</h4>
            <p class="text-muted">Добавьте первый сайт в этот проект</p>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addWebsiteModal">
                <i class="fas fa-plus"></i> Добавить первый сайт
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Модальное окно для добавления/редактирования сайта -->
<div class="modal fade" id="addWebsiteModal" tabindex="-1" aria-labelledby="addWebsiteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWebsiteModalLabel">Добавить новый сайт</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addWebsiteForm" enctype="multipart/form-data">
                    <input type="hidden" id="websiteProjectId" value="{{ project.id }}">
                    <div class="mb-3">
                        <label for="websiteName" class="form-label">Название сайта *</label>
                        <input type="text" class="form-control" id="websiteName" required>
                    </div>
                    <div class="mb-3">
                        <label for="websiteUrl" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="websiteUrl" required>
                    </div>
                    <div class="mb-3">
                        <label for="websiteStatus" class="form-label">Статус</label>
                        <select class="form-select" id="websiteStatus">
                            <option value="Не начат">Не начат</option>
                            <option value="В работе">В работе</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="websiteScreenshot" class="form-label">Скриншот сайта</label>
                        <input type="file" class="form-control" id="websiteScreenshot" accept="image/*">
                        <div class="form-text">Поддерживаемые форматы: PNG, JPG, JPEG, GIF, WebP (макс. 16MB)</div>
                        <div id="screenshotPreview" class="mt-2" style="display: none;">
                            <img id="previewImage" src="" alt="Предпросмотр" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="saveWebsite()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования проекта -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProjectModalLabel">Редактировать проект</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProjectForm">
                    <div class="mb-3">
                        <label for="editProjectName" class="form-label">Название проекта *</label>
                        <input type="text" class="form-control" id="editProjectName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="editProjectDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectStatus" class="form-label">Статус</label>
                        <select class="form-select" id="editProjectStatus">
                            <option value="Активный">Активный</option>
                            <option value="В работе">В работе</option>
                            <option value="Завершен">Завершен</option>
                            <option value="Приостановлен">Приостановлен</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-warning" onclick="saveProjectEdit()">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<script>
let editingWebsiteId = null;

// Функция для экранирования HTML символов
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Загрузка технологий и портов для каждого сайта
document.addEventListener('DOMContentLoaded', function() {
    {% for website in websites %}
    loadTechnologies({{ website.id }});
    loadPorts({{ website.id }}, {{ website.url|tojson }}, {{ project.id }});
    {% endfor %}
});

function loadTechnologies(websiteId) {
    fetch(`/api/websites/${websiteId}/technologies`)
        .then(response => response.json())
        .then(technologies => {
            const container = document.getElementById(`technologies-${websiteId}`);
            if (technologies.length > 0) {
                const techBadges = technologies.map(tech => 
                    `<span class="badge bg-info me-1">${escapeHtml(tech.name)}${tech.version ? ' ' + escapeHtml(tech.version) : ''}</span>`
                ).join('');
                container.innerHTML = techBadges;
            } else {
                container.innerHTML = '<small class="text-muted">Не указаны</small>';
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки технологий:', error);
            document.getElementById(`technologies-${websiteId}`).innerHTML = '<small class="text-danger">Ошибка загрузки</small>';
        });
}

async function loadPorts(websiteId, websiteUrl, projectId) {
    const container = document.getElementById(`ports-${websiteId}`);
    try {
        const domainName = (websiteUrl || '').replace(/^https?:\/\/(www\.)?/, '').split('/')[0].toLowerCase();
        const listRes = await fetch(`/api/projects/${projectId}/attack-surfaces`);
        const listData = await listRes.json();
        if (!listData.success || !listData.attack_surfaces || listData.attack_surfaces.length === 0) {
            container.innerHTML = '<small class="text-muted">Не указаны</small>';
            return;
        }
        let rendered = false;
        for (const as of listData.attack_surfaces) {
            const dRes = await fetch(`/api/attack-surfaces/${as.id}/domains`);
            const dData = await dRes.json();
            if (!dData.success || !dData.domains) continue;
            const match = dData.domains.find(x => (x.domain || '').replace(/^https?:\/\/(www\.)?/, '').split('/')[0].toLowerCase() === domainName);
            if (match && match.ip) {
                const pRes = await fetch(`/api/attack-surfaces/${as.id}/domains/${match.id}/ports`);
                const pData = await pRes.json();
                if (pData.success && Array.isArray(pData.ports) && pData.ports.length > 0) {
                    const html = pData.ports.map(p => `<span class=\"badge bg-secondary me-1\">${escapeHtml(String(p.port))}/${escapeHtml(p.protocol || 'tcp')}${p.service ? ' (' + escapeHtml(p.service) + ')' : ''}</span>`).join('');
                    container.innerHTML = html;
                    rendered = true;
                    break;
                }
            }
        }
        if (!rendered) {
            container.innerHTML = '<small class="text-muted">Не указаны</small>';
        }
    } catch (e) {
        console.error('Ошибка загрузки портов:', e);
        container.innerHTML = '<small class="text-danger">Ошибка загрузки</small>';
    }
}

function saveWebsite() {
    const screenshotFile = document.getElementById('websiteScreenshot').files[0];
    const url = editingWebsiteId ? `/api/websites/${editingWebsiteId}` : '/api/websites';
    const method = editingWebsiteId ? 'PUT' : 'POST';
    
    let requestOptions;
    
    if (screenshotFile) {
        // Если есть файл, используем FormData
        const formData = new FormData();
        formData.append('name', document.getElementById('websiteName').value);
        formData.append('url', document.getElementById('websiteUrl').value);
        formData.append('status', document.getElementById('websiteStatus').value);
        formData.append('project_id', document.getElementById('websiteProjectId').value);
        formData.append('screenshot', screenshotFile);
        
        requestOptions = {
            method: method,
            body: formData
        };
    } else {
        // Если файла нет, используем JSON
        const data = {
            name: document.getElementById('websiteName').value,
            url: document.getElementById('websiteUrl').value,
            status: document.getElementById('websiteStatus').value,
            project_id: document.getElementById('websiteProjectId').value
        };
        
        requestOptions = {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        };
    }
    
    fetch(url, requestOptions)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Ошибка: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при сохранении сайта');
    });
}

function editWebsite(websiteId) {
    editingWebsiteId = websiteId;
    
    fetch(`/api/websites/${websiteId}`)
    .then(response => response.json())
    .then(website => {
        document.getElementById('websiteName').value = website.name;
        document.getElementById('websiteUrl').value = website.url;
        document.getElementById('websiteStatus').value = website.status;
        
        document.getElementById('addWebsiteModalLabel').textContent = 'Редактировать сайт';
        
        const modal = new bootstrap.Modal(document.getElementById('addWebsiteModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при загрузке данных сайта');
    });
}

function deleteWebsite(websiteId) {
    if (confirm('Вы уверены, что хотите удалить этот сайт?')) {
        fetch(`/api/websites/${websiteId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Ошибка: ' + data.error);
            } else {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при удалении сайта');
        });
    }
}

function editProject(projectId) {
    fetch(`/api/projects/${projectId}`)
    .then(response => response.json())
    .then(project => {
        document.getElementById('editProjectName').value = project.name;
        document.getElementById('editProjectDescription').value = project.description || '';
        document.getElementById('editProjectStatus').value = project.status;
        
        const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при загрузке данных проекта');
    });
}

function saveProjectEdit() {
    const projectData = {
        name: document.getElementById('editProjectName').value,
        description: document.getElementById('editProjectDescription').value,
        status: document.getElementById('editProjectStatus').value
    };
    
    fetch(`/api/projects/{{ project.id }}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(projectData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Ошибка: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при сохранении проекта');
    });
}

// Предпросмотр изображения
document.getElementById('websiteScreenshot').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('screenshotPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('screenshotPreview').style.display = 'none';
    }
});

// Сброс формы при закрытии модального окна
document.getElementById('addWebsiteModal').addEventListener('hidden.bs.modal', function () {
    editingWebsiteId = null;
    document.getElementById('addWebsiteForm').reset();
    document.getElementById('addWebsiteModalLabel').textContent = 'Добавить новый сайт';
    document.getElementById('screenshotPreview').style.display = 'none';
    document.getElementById('websiteProjectId').value = '{{ project.id }}';
});
</script>
{% endblock %}
